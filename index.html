<html>
  <head>
    <title>SamBamViz VIZualizer</title>
    <style>
      body {
        font-family: 'Helvetica', 'Arial', sans-serif;
        color: #444444;
        background-color: hsl(0, 0%, 98%);
      }

      #layout {
        display: flex;
        width: 100%;
        height: 100%;
      }

      #options {
        height: 100%;
        width: 20%;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding-left: 2vw;
        background-color: #eee;
      }

      #graph {
        height: 100%;
        width: 80%;
        display: flex;
        flex-direction: row;
        align-items: center;
        padding: 0vw 3vw;
      }

      #view {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        padding: 0vw 3vw;
      }

      #color-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    </style>
  </head>
  <body>
    <div id="layout">
      <div id="options">
        <div>
          <h3>File Upload</h3>
          <label>Select SamBamViz File:</label>
          <input type="file" id="sambamviz-upload" />
          <br />
          <br />
          <label>Select FASTA File: (optional)</label>
          <input type="file" id="fasta-upload" />
          <br /><br />
          <button id="upload-files">Load Files</button>
          <h3>Color Picker</h3>
          <div id="color-grid">
            <label>A</label>
            <input
              class="color-picker"
              id="a-color"
              type="color"
              value="#65F73E"
            />
            <label>C</label>
            <input
              class="color-picker"
              id="c-color"
              type="color"
              value="#FFB340"
            />
            <label>G</label>
            <input
              class="color-picker"
              id="g-color"
              type="color"
              value="#EB413C"
            />
            <label>T</label>
            <input
              class="color-picker"
              id="t-color"
              type="color"
              value="#3C89EE"
            />
            <label>Other</label>
            <input
              class="color-picker"
              id="n-color"
              type="color"
              value="#000000"
            />
          </div>

          <h3>Y-Axis Options</h3>
          <form>
            <input type="radio" id="count-option" name="yaxis" checked="true" />
            <label for="count-option">Count (Linear Scale)</label>
            <br />
            <input type="radio" id="log-option" name="yaxis" />
            <label for="log-option">Count (Log Scale)</label>
            <br />
            <input type="radio" id="proportion-option" name="yaxis" />
            <label for="proportion-option">Proportion</label>
          </form>
          <h3>Range of Data</h3>
          <div id="range-selector">
            <span>Lower:</span>
            <input type="number" id="lower-bound" min="0" max="0" />
            <br />
            <span>Upper:</span>
            <input type="number" id="upper-bound" min="0" max="0" />
          </div>
          <br />
          <button id="loadGraph">Update</button>
        </div>
      </div>
      <div id="graph">
        <div id="view"></div>
      </div>
    </div>

    <script src="init.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <!-- <script src="d3.v7.min.js"></script>
    <script src="vega-embed@6.js"></script>
    <script src="vega-lite@5.js"></script>
    <script src="vega@5.js"></script> -->
    <script src="tsv-loader-vega.js"></script>
    <script src="bar-chart.js"></script>

    <script type="text/javascript">
      document.getElementById('upload-files').addEventListener('click', (e) => {
        generateData();

        let lowerDataBound = BOUNDS.low;
        let upperDataBound = BOUNDS.high;
        loadSBV(lowerDataBound, upperDataBound, tsvDataCount, tsvDataProp);
      });

      document
        .getElementById('sambamviz-upload')
        .addEventListener('change', (e) => {
          processFiles(SBV);
        });

      document
        .getElementById('fasta-upload')
        .addEventListener('change', (e) => {
          processFiles(FAS);
        });

      async function generateData() {
        try {
          await tsvToArr(tsvString);
        } catch (error) {
          console.log(error);
        }
      }

      async function processFiles(fileType) {
        try {
          if (fileType === SBV) {
            const sbvFile =
              document.getElementById('sambamviz-upload').files[0];
            await processSamBamViz(sbvFile);
          }

          if (fileType === FAS) {
            const fasFile = document.getElementById('fasta-upload').files[0];
            await processFasta(fasFile);
          }
        } catch (error) {
          console.log(error);
        }
      }

      function processSamBamViz(file) {
        return new Promise((resolve, reject) => {
          let reader = new FileReader();

          reader.onload = () => {
            tsvString = reader.result;
            resolve('done');
          };

          reader.readAsText(file);
        });
      }

      function processFasta(file) {
        return new Promise((resolve, reject) => {
          let reader = new FileReader();

          reader.onload = () => {
            genSeq = [];
            let genSeqStr = reader.result;
            for (
              let i = genSeqStr.indexOf('\n') + 1;
              i < genSeqStr.length;
              i++
            ) {
              if (genSeqStr[i] != '\n') {
                genSeq.push(genSeqStr[i]);
              }
            }
            resolve('done');
          };

          reader.readAsText(file);
        });
      }

      function setVegaScheme() {
        COLORS.A = document.getElementById('a-color').value;
        COLORS.C = document.getElementById('c-color').value;
        COLORS.G = document.getElementById('g-color').value;
        COLORS.T = document.getElementById('t-color').value;
        COLORS.N = document.getElementById('n-color').value;
      }

      document.querySelectorAll('.color-picker').forEach((input) => {
        input.addEventListener('change', (e) => {
          setVegaScheme();
        });
      });

      function loadSBV(lowerDataBound, upperDataBound, tsvData, tsvDataProp) {
        vega.scheme('strands', [
          COLORS.A,
          COLORS.C,
          COLORS.G,
          COLORS.T,
          COLORS.N
        ]);

        let data = tsvData.slice(
          lowerDataBound * DATA_PER_POS,
          upperDataBound * DATA_PER_POS
        );

        if (document.getElementById('count-option').checked) {
          loadBarGraph(tsvData.slice(
              lowerDataBound * DATA_PER_POS,
              upperDataBound * DATA_PER_POS), COUNT);
        } else if (document.getElementById('log-option').checked) {
          loadBarGraph(tsvData.slice(
              lowerDataBound * DATA_PER_POS,
              upperDataBound * DATA_PER_POS), LOG);
        } else if (document.getElementById('proportion-option').checked) {
          loadBarGraph(tsvDataProp.slice(
              lowerDataBound * DATA_PER_POS,
              upperDataBound * DATA_PER_POS), PROPORTION);
        }
      }

      document.getElementById('loadGraph').addEventListener('click', (e) => {
        // let yAxisOption = COUNT;

        let lowerDataBound = BOUNDS.low;
        let upperDataBound = BOUNDS.high;

        // if (document.getElementById('count-option').checked) {
        //   yAxisOption = COUNT;
        // } else if (document.getElementById('log-option').checked) {
        //   yAxisOption = LOG;
        // } else if (document.getElementById('proportion-option').checked) {
        //   yAxisOption = PROPORTION;
        // }
        
        lowerDataBound = parseInt(document.getElementById('lower-bound').value);
        upperDataBound =
          parseInt(document.getElementById('upper-bound').value) + 1;

        // vega.scheme('strands', [
        //   COLORS.A,
        //   COLORS.C,
        //   COLORS.G,
        //   COLORS.T,
        //   COLORS.N
        // ]);

        // added
        loadSBV(lowerDataBound, upperDataBound, tsvDataCount, tsvDataProp);

        // if (yAxisOption == COUNT) {
        //   loadBarGraph(
        //     tsvDataCount.slice(
        //       lowerDataBound * DATA_PER_POS,
        //       upperDataBound * DATA_PER_POS
        //     ),
        //     yAxisOption
        //   );
        // } else if (yAxisOption == LOG) {
        //   loadBarGraph(
        //     tsvDataCount.slice(
        //       lowerDataBound * DATA_PER_POS,
        //       upperDataBound * DATA_PER_POS
        //     ),
        //     yAxisOption
        //   );
        // } else if (yAxisOption == PROPORTION) {
        //   loadBarGraph(
        //     tsvDataProp.slice(
        //       lowerDataBound * DATA_PER_POS,
        //       upperDataBound * DATA_PER_POS
        //     ),
        //     yAxisOption
        //   );
        // }
      });
    </script>
  </body>
</html>
